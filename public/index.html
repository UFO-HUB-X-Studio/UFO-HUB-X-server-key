<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>UFO HUB X</title>
<meta name="theme-color" content="#0a1411"/>
<meta name="color-scheme" content="dark"/>

<link rel="preload" as="image" href="/img/bg">
<link rel="preload" as="image" href="/img/profile">
<link rel="preload" as="image" href="https://cdn.discordapp.com/attachments/1417098355388973154/1418950206808133672/BackgroundEraser_20250916_190732755.png">

<style>
:root{
  --ufo:#00ff99; --text:#d9fff5;
  --panel1:rgba(9,16,23,.88); --panel2:rgba(8,13,19,.92);
  --glow:rgba(34,255,200,.10);
  --hero-img:url("/img/profile");
  --ufo-ship:url("https://cdn.discordapp.com/attachments/1417098355388973154/1418950206808133672/BackgroundEraser_20250916_190732755.png?ex=68cffbdc&is=68ceaa5c&hm=67ec141db70602a4afe4f884154e87c8055698d901966c7100a6b501c21b5125&");
}

/* layout */
html,body{height:100%;margin:0;background:#0a1411;color:var(--text);font-family:"Orbitron",system-ui,Segoe UI,Roboto,Arial,sans-serif}
body.locked{overflow:hidden}
.container{max-width:920px;margin:22px auto 92px;padding:0 18px}

/* hero */
.hero{display:flex;justify-content:center;margin:8px 0 20px}
.hero-box{display:inline-block;max-width:320px;width:90vw;border-radius:18px;overflow:hidden;position:relative;background:radial-gradient(1200px 400px at 50% -200px, rgba(0,255,160,.12), transparent 70%), #0b1a15;box-shadow:0 0 28px rgba(0,255,160,.18)}
.hero-img{display:block;width:100%;height:auto;object-fit:contain;background:var(--hero-img) center/contain no-repeat}

/* card */
.card{background:linear-gradient(180deg,var(--panel1),var(--panel2));border-radius:18px;box-shadow:0 0 0 1px rgba(34,255,200,.06) inset,0 10px 30px rgba(0,0,0,.55),0 0 34px var(--glow);padding:18px;margin-bottom:22px;backdrop-filter:blur(2px);overflow:visible}
.head{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
.head-title{margin:0;font-size:40px;letter-spacing:.6px;text-shadow:0 0 12px rgba(0,255,170,.15)}
.head-title .ufo{color:#fff} .head-title .hubx{color:var(--ufo)}
.start-btn{appearance:none;border:0;cursor:pointer;padding:10px 18px;border-radius:14px;font-weight:800;background:var(--ufo);color:#072017;box-shadow:0 6px 18px rgba(0,255,140,.25),0 0 0 1px rgba(0,0,0,.25) inset}

/* progress */
.progress-meta{display:flex;align-items:center;justify-content:space-between;margin-top:10px;margin-bottom:6px;font-weight:800;font-size:14px;color:#cffff2;position:relative;z-index:2;transition:opacity .35s ease}
.bar-wrap{position:relative;width:100%;height:18px;border-radius:10px;overflow:visible;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.35));box-shadow:inset 0 0 0 1px rgba(34,255,200,.10);transition:opacity .35s ease}
.is-hidden{opacity:0;pointer-events:none}
.bar{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#00ffa3,#3bffbf);box-shadow:0 0 18px rgba(34,255,200,.35);z-index:1;transition:width .12s linear,opacity .2s linear}
.bar-ufo{position:absolute;top:50%;transform:translate(-50%,-50%);width:50px;height:50px;opacity:0;transition:opacity .2s ease,left .12s linear;background:var(--ufo-ship) center/contain no-repeat;filter:drop-shadow(0 0 2px #fff) drop-shadow(0 0 14px rgba(0,255,160,.9))}

/* overlay */
.overlay{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(4,10,9,.75);backdrop-filter:blur(4px)}
.overlay.hidden{display:none}
.dl-box{width:min(360px,92vw);padding:22px 20px;border-radius:18px;background:linear-gradient(180deg, rgba(9,16,23,.92), rgba(8,13,19,.96));box-shadow:0 0 0 1px rgba(34,255,200,.12) inset, 0 20px 60px rgba(0,0,0,.6);text-align:center}
.spinner{margin:8px auto 12px;width:72px;height:72px;border-radius:50%;border:6px solid rgba(0,255,160,.18);border-top-color:#00ffa3;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.dl-title{font-weight:900;font-size:20px;color:#cffff2;margin:2px 0 8px}
.dl-count{font-size:24px;font-weight:900;color:#ffea63;text-shadow:0 0 10px rgba(255,234,99,.35)}
.dl-note{font-size:12px;opacity:.85;color:#b9ffee;margin-top:8px}
</style>
</head>
<body>
  <div class="container">
    <div class="hero">
      <div class="hero-box"><img class="hero-img" src="/img/profile" alt="UFO HUB X"></div>
    </div>

    <section class="card">
      <div class="head">
        <h1 class="head-title"><span class="ufo">UFO</span> <span class="hubx">HUB X</span></h1>
        <button class="start-btn" id="startBtn">🟢 START</button>
      </div>

      <!-- กรอบจะโผล่หลัง ARM_DELAY -->
      <div class="progress-meta is-hidden" id="progressMeta">
        <div id="progressText">Progress: 0/1</div>
        <div id="percentText">0%</div>
      </div>

      <div class="bar-wrap is-hidden" id="barWrap" aria-hidden="true">
        <div class="bar" id="bar" style="opacity:0;width:0%"></div>
        <div class="bar-ufo" id="barUfo" style="left:8px"></div>
      </div>
    </section>
  </div>

  <div class="overlay hidden" id="dlOverlay" aria-live="polite" aria-busy="true">
    <div class="dl-box">
      <div class="spinner" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
      <div class="dl-title">Preparing download…</div>
      <div class="dl-count"><span id="dlSeconds">0</span>%</div>
      <div class="dl-note">Please wait while we get things ready.</div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const START_URL = "https://direct-link.net/1398143/IGoZdaaTcIHW";
const DOMAIN_OK = "ufo-hub-x-key-umoq.onrender.com";
const RETURN_KEY = "ufo_return_ts";
const ARM_DELAY = 18000;        // 18s show frame
const MIN_VISIT = 5000;         // must be away >=5s
const UFO_PROGRESS_MS = 22000;  // 22s green bar run
const OVERLAY_MS = 20000;       // overlay 20s

/* ====== ELEMENTS ====== */
const bar = document.getElementById('bar');
const barWrap = document.getElementById('barWrap');
const barUfo = document.getElementById('barUfo');
const progressMeta = document.getElementById('progressMeta');
const pText = document.getElementById('progressText');
const percentEl = document.getElementById('percentText');
const startBtn = document.getElementById('startBtn');
const dlOverlay = document.getElementById('dlOverlay');
const dlSeconds = document.getElementById('dlSeconds');

let raf = null;

/* ====== Utility / Guard helpers ====== */
function safeUnhideFrame(){
  if(progressMeta.classList.contains('is-hidden')) progressMeta.classList.remove('is-hidden');
  if(barWrap.classList.contains('is-hidden')) barWrap.classList.remove('is-hidden');
  barWrap.setAttribute('aria-hidden','false');
}
function safeHideGreenBar(){
  if(bar) { bar.style.width = '0%'; bar.style.opacity = '0'; }
  if(barUfo) barUfo.style.opacity = '0';
}
function ensureBarVisibleInstantly(){
  if(bar) bar.style.opacity = '1';
}

/* ====== setProgress (robust) ====== */
function setProgress(p){
  if (!bar || !barWrap) return;
  if (p < 0) p = 0; if (p > 100) p = 100;
  // ensure frame visible if some code tried to set before frame shown
  safeUnhideFrame();
  // width
  bar.style.width = p + '%';
  // move UFO to the tip (calculate even if bar width changed)
  try{
    const barRect = bar.getBoundingClientRect();
    const wrapRect = barWrap.getBoundingClientRect();
    const tipInside = (barRect.left + barRect.width) - wrapRect.left;
    const lead = 8;
    // clamp left
    const leftX = Math.max(lead, tipInside + lead);
    barUfo.style.left = leftX + 'px';
  }catch(e){}
  // percent text
  percentEl.textContent = Math.round(p) + '%';
  // progress label: stays 0/1 until reach 100
  pText.textContent = 'Progress: ' + (p >= 100 ? '1/1' : '0/1');
}

/* ====== runProgress (unhide if needed) ====== */
function runProgress(pTarget = 100, duration = UFO_PROGRESS_MS){
  if (!bar || !barWrap) return;
  // if frame not yet shown, unhide immediately to let user see progress
  safeUnhideFrame();
  // show green bar and UFO
  ensureBarVisibleInstantly();
  barUfo.style.opacity = '1';
  cancelAnimationFrame(raf);
  const pStart = parseFloat(bar.style.width) || 0;
  const t0 = performance.now();
  function tick(ts){
    const t = Math.min(1, (ts - t0) / duration);
    const p = pStart + (pTarget - pStart) * t;
    setProgress(p);
    if (t < 1) {
      raf = requestAnimationFrame(tick);
    } else {
      // keep UFO visible for a short instant then fade
      setTimeout(()=>{ barUfo.style.opacity = '0'; }, 300);
    }
  }
  raf = requestAnimationFrame(tick);
}

/* ====== showDownloadOverlay (on specific domain) ====== */
function showDownloadOverlay(){
  if (location.hostname !== DOMAIN_OK) return;
  document.body.classList.add('locked');
  dlOverlay.classList.remove('hidden');
  const start = Date.now();
  const timer = setInterval(()=>{
    const elapsed = Date.now() - start;
    const pct = Math.min(100, Math.floor((elapsed/OVERLAY_MS)*100));
    dlSeconds.textContent = pct;
    // aria
    const spinner = dlOverlay.querySelector('.spinner');
    if (spinner) spinner.setAttribute('aria-valuenow', String(pct));
    if (elapsed >= OVERLAY_MS){
      clearInterval(timer);
      dlOverlay.classList.add('hidden');
      document.body.classList.remove('locked');
    }
  }, 100);
}

/* ====== Preload images (non-blocking) ====== */
function preloadImages(urls, timeout=20000){
  return new Promise(resolve=>{
    let done=false;
    const timer = setTimeout(()=>{ if(!done){ done=true; resolve(); } }, timeout);
    let loaded=0;
    urls.forEach(u=>{
      const img = new Image();
      img.onload = img.onerror = ()=>{ if(done) return; if(++loaded >= urls.length){ done=true; clearTimeout(timer); resolve(); } };
      img.src = u;
    });
  });
}

/* ====== Start button behaviour ====== */
startBtn.addEventListener('click', ()=>{
  try{
    // mark return timestamp and session flag (so we know user actually left)
    localStorage.setItem(RETURN_KEY, String(Date.now()));
    sessionStorage.setItem('ufo_started_session', '1');
  }catch(e){}
  // go to external START_URL
  window.location.href = START_URL;
});

/* ====== Return detection ====== */
function isValidReturn(){
  try{
    const ts = parseInt(localStorage.getItem(RETURN_KEY) || "0", 10);
    if (!ts) return false;
    return (Date.now() - ts) >= MIN_VISIT;
  }catch(e){ return false; }
}
function clearReturnMark(){ try{ localStorage.removeItem(RETURN_KEY)}catch(e){} }

/* ====== autoCompleteIfReturned (called on pageshow) ====== */
function autoCompleteIfReturned(onlyIfVisible = false){
  // only react on expected domain
  if (location.hostname !== DOMAIN_OK) return;
  // if onlyIfVisible and UI still hidden, skip
  if (onlyIfVisible && (progressMeta.classList.contains('is-hidden') || barWrap.classList.contains('is-hidden'))) return;
  if (isValidReturn()){
    // ensure user had actually started session at least once (defensive)
    const started = sessionStorage.getItem('ufo_started_session') === '1';
    // If user started in this session OR it's okay to accept cross-session returns, allow:
    if (started) {
      clearReturnMark();
      runProgress(100, UFO_PROGRESS_MS);
    } else {
      // In case session was lost (e.g., incognito), still allow if we detect RETURN_KEY - permissive fallback:
      clearReturnMark();
      runProgress(100, UFO_PROGRESS_MS);
    }
  }
}

/* ====== show frame after ARM_DELAY ====== */
function showBarAfterDelay(){
  setTimeout(()=>{
    safeUnhideFrame();
    // initial label remains 0/1
    pText.textContent = 'Progress: 0/1';
    percentEl.textContent = '0%';
    // if user already returned (pageshow may not fire), check now
    autoCompleteIfReturned(true);
  }, ARM_DELAY);
}

/* ====== hook pageshow (handles BFCache back navigation) ====== */
window.addEventListener('pageshow', ()=>{
  // pageshow can indicate back/forward or reload
  autoCompleteIfReturned(true);
});

/* ====== on DOM ready ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  // start hidden (as original)
  progressMeta.classList.add('is-hidden');
  barWrap.classList.add('is-hidden');
  // ensure bar hidden
  safeHideGreenBar();
  // preload images non-blocking
  preloadImages(['/img/bg','/img/profile','https://cdn.discordapp.com/attachments/1417098355388973154/1418950206808133672/BackgroundEraser_20250916_190732755.png']);
  // show overlay on domain only
  showDownloadOverlay();
  // schedule frame reveal after ARM_DELAY
  showBarAfterDelay();
});

/* ====== extra: if some script externally calls runProgress before frame shown, ensure it still runs ====== */
(function patchIfMissing(){
  // if some other code overwrote runProgress earlier we respect it; else we expose our runProgress
  if (!window.runProgress) window.runProgress = runProgress;
  if (!window.setProgress) window.setProgress = setProgress;
  // allow external trigger: window.forceShowProgressFrame()
  window.forceShowProgressFrame = safeUnhideFrame;
})();
</script>
</body>
</html>
