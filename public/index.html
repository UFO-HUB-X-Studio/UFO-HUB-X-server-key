const express = require("express");
const fs = require("fs");
const path = require("path");

const app  = express();
const PORT = process.env.PORT || 3000;

function loadConfig() {
  const configPath = path.join(__dirname, "config.json");
  return JSON.parse(fs.readFileSync(configPath, "utf8"));
}

// health
app.get("/", (req, res) => {
  res.json({ ok: true, service: "UFO-HUB-X key server" });
});

// ---------------------- GETKEY ----------------------
// รับ uid (ไม่บังคับ) แล้วส่ง key ตัวแรก + ttl กลับไปแบบง่าย ๆ
app.get("/getkey", (req, res) => {
  const uid = req.query.uid || "";
  try {
    const config = loadConfig();
    const firstKey = config.keys[0] ? config.keys[0].key : null;

    res.json({
      ok: true,
      uid,
      key: firstKey,
      ttl: (config.expires_default || 172800)
    });
  } catch (err) {
    console.error("getkey error:", err);
    res.status(500).json({ ok: false, error: "server_error" });
  }
});

// ---------------------- VERIFY ----------------------
// ตรวจว่า key ตรงใน config ไหม (ไม่ตัดอายุฝั่งเซิร์ฟเวอร์เพื่อความง่าย)
// ให้ client เป็นฝ่าย “ตั้งหมดอายุครั้งแรก” แล้วใช้อายุเดิมจนหมดอายุจริง ๆ
app.get("/verify", (req, res) => {
  const uid = (req.query.uid || "").trim();
  const key = (req.query.key || "").trim();

  try {
    const config = loadConfig();
    const found = config.keys.find(k => k.key === key);

    if (!found) {
      return res.json({ ok: true, valid: false, reason: "invalid" });
    }

    // ส่งกลับว่า valid + ttl ที่ควรใช้สร้าง expires_at ฝั่ง client (ครั้งแรกที่ยืนยัน)
    res.json({
      ok: true,
      valid: true,
      ttl: found.ttl || config.expires_default || 172800,
      reusable: !!found.reusable
    });
  } catch (err) {
    console.error("verify error:", err);
    res.status(500).json({ ok: false, error: "server_error" });
  }
});

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
