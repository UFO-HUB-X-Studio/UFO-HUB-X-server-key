<script>
/* UFO HUB X — Smart iOS Redirect (v2, robust)
 * - Detects iPhone / iPod / iPad (รวม iPadOS 13+ ที่ UA = "Macintosh")
 * - Keeps query & hash when redirecting
 * - ?platform=ios / ?platform=android to override (ทดสอบง่าย)
 * - Avoids loops with sessionStorage flag and path check
 * - Skips redirect on bots, API paths, or when already on ios.html
 */
(function () {
  try {
    var loc = window.location;
    var path = loc.pathname || "/";
    var search = loc.search || "";
    var hash = loc.hash || "";

    // ---- 1) อนุญาต override จาก query ----
    var params = new URLSearchParams(search);
    var override = (params.get("platform") || "").toLowerCase(); // ios / android / none

    // ---- 2) กันบอท/เงื่อนไขที่ไม่ควร redirect ----
    var isBot = /bot|crawler|spider|preview|facebookexternalhit/i.test(navigator.userAgent || "");
    var isAPI = /^\/api(\/|$)/.test(path); // ถ้าเป็น endpoint API
    if (isBot || isAPI) return;

    // ---- 3) ตรวจว่าอยู่บนหน้า ios.html อยู่แล้ว และกันลูปด้วย sessionStorage ----
    var alreadyIOS = /\/ios\.html$/i.test(path);
    var loopFlagKey = "ufo_ios_redirect_done";
    var redirectedBefore = sessionStorage.getItem(loopFlagKey) === "1";

    // ---- 4) ตรวจ iOS อย่างแม่นยำ ----
    var ua = navigator.userAgent || "";
    var platform = navigator.platform || "";
    var maxTouch = navigator.maxTouchPoints || 0;

    // iPhone/iPod แบบชัดเจน
    var isiPhoneOrPod = /iPhone|iPod/i.test(ua);

    // iPad แบบเก่า (UA มี iPad)
    var isiPadUA = /iPad/i.test(ua);

    // iPadOS 13+ (UA กลายเป็น "Macintosh" แต่มีจอสัมผัส)
    var isiPadMacLike = /Macintosh/i.test(ua) && (maxTouch > 1);

    // iOS WebView/Standalone ก็ถือว่า iOS
    var isStandalone = window.navigator.standalone === true; // PWA on iOS

    var isiOS = isiPhoneOrPod || isiPadUA || isiPadMacLike || isStandalone;

    // ---- 5) เงื่อนไขตัดสินใจ redirect ----
    // กรณี override
    if (override === "ios") isiOS = true;
    if (override === "android") isiOS = false;

    // ไม่ต้อง redirect ถ้า:
    // - ไม่ใช่ iOS
    // - อยู่ที่ ios.html อยู่แล้ว
    // - เคย redirect ไปแล้วใน session นี้ (กันลูปย้อนกลับ)
    if (!isiOS || alreadyIOS || redirectedBefore) return;

    // ---- 6) คำนวณ URL เป้าหมาย พร้อมคง query/hash เดิม ----
    var base = path.replace(/\/[^/]*$/, "/"); // โฟลเดอร์ปัจจุบัน
    var target = base + "ios.html";

    // เก็บ query/hash เดิมไว้ (แต่ลบ platform override ทิ้งเพื่อความเนียน)
    if (params.has("platform")) {
      params.delete("platform");
    }
    var keepQuery = params.toString();
    if (keepQuery) target += "?" + keepQuery;
    if (hash) target += hash;

    // ---- 7) ตั้งธงกันลูป & redirect ----
    sessionStorage.setItem(loopFlagKey, "1");
    // ใช้ location.replace() เพื่อไม่ให้กด back แล้วย้อนลูป
    location.replace(target);
  } catch (err) {
    // เงียบไว้ ถ้ามีปัญหา อย่าให้ผู้ใช้เด้งหรือค้าง
    console.error("[iOS redirect] error:", err);
  }
})();
    </script>
